<!DOCTYPE html>
<html>
    <head>
        <title>Socket.IO chat</title>
        <style>
            body {
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", Meiryo, sans-serif;
                margin: 0;
                padding: 24px;
                background: #f6f7f9;                
            }

            h1 {
                margin: 0 0 16px;
                font-size: 22px;
            }

            .chat-container {
                max-width: 640px;
                margin: 0 auto;
            }

            #show-message {
                list-style: none;
                padding: 0;
                margin: 0 0 16px;
                border: 1px solid #d0d7de;
                background: #7bb7ff;
                border-radius: 8px;

                width: 100%;
                height: 55vh;
                overflow-y: auto;
            }
            
            #form {
                display: flex;
                gap: 8px;
                width: 100%;
            }           
            
            #message {
                flex: 1;
                padding: 10px 12px;
                border: 1px solid #d0d7de;
                border-radius: 8px;
                font-size: 14px;
            }

            button {
                padding: 10px 14px;
                border: none;
                border-radius: 8px;
                background: #2f6feb;
                color: #fff;
                font-size: 14px;
                cursor: pointer;
            }

            button:active {
                transform: translateY(1px);
            }       
            
            .message-row {
                display: flex;
                margin-bottom: 10px;
            }

            .message-row.self {
                justify-content: flex-end;
                padding-left: 120px;
                padding-right: 16px;
            }

            .message-row.other {
                justify-content: flex-start;
                padding-right: 120px;
                padding-left: 16px;
            }

            .bubble {
                padding: 10px 14px;
                font-size: 14px;
                line-height: 1.4;
                word-break: break-word;
                position: relative;
                white-space: pre-wrap;
                box-sizing: border-box;
            }

            .self .bubble {
                background: #9fe870;
                border-radius: 16px;
            }

            .other .bubble {
                background: #ffffff;
                border-radius: 16px;
            }

            .time {
                font-size: 11px;
                color: #555;
                margin: 0 6px;
                align-self: flex-end;
            }

            .name {
                font-size: 11px;
                color: #444;
                margin-bottom: 2px;
                white-space: nowrap;
            }

            .self .name {
                text-align: right;
            }

            .other .name {
                text-align: left;
            }
        </style>
    </head>
    <body>
        <div class="chat-container">
            <h1>チャットデモ</h1>
            <ul id="show-message"></ul>
            <form id="form">
                <input id="message" placeholder="message" autocomplete="off">
                    <button type="submit">
                    送信
                    </button>
            </form>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            const form = document.getElementById("form");
            const message = document.getElementById("message");
            const showMessages = document.getElementById("show-message");

            const name = prompt("名前:");
            const socket = io();

            form.addEventListener("submit", (e) => {
                e.preventDefault();

                if (!message.value.trim()) return;

                postMsg(name, message.value);
                message.value = "";
            });

            function postMsg(name, msg) {
                const data = {
                    name,
                    msg,
                };
                socket.emit("msgPost", data);
            }

        socket.on("msgGet", (data) => {
            const row = document.createElement("div");
            const content = document.createElement("div");
            const nameEl = document.createElement("div");
            const bubble = document.createElement("div");
            const time = document.createElement("div");

            const isSelf = data.name === name;

            row.classList.add("message-row", isSelf ? "self" : "other");
            content.style.display = "flex";
            content.style.flexDirection = "column";

            nameEl.classList.add("name");
            nameEl.textContent = data.name;

            bubble.classList.add("bubble");
            bubble.textContent = wrapText(data.msg, 15);

            time.classList.add("time");

            const date = data.time ? new Date(data.time) : new Date();
            time.textContent = date.toLocaleTimeString("ja-JP", {
                hour: "2-digit",
                minute: "2-digit",
            });

            content.appendChild(nameEl);
            content.appendChild(bubble);

            if (isSelf) {
                row.appendChild(time);
                row.appendChild(content);
            } else {
                row.appendChild(content);
                row.appendChild(time);
            }

            showMessages.appendChild(row);
            showMessages.scrollTop = showMessages.scrollHeight;
        });

        window.addEventListener("pageshow", (event) => {
            if (event.persisted) {
                location.reload();
            }
        });

        function wrapText(text, limit = 15) {
            const regex = new RegExp(`(.{${limit}})`, "g");
            return text.replace(regex, "$1\n");
        }
        </script>
    </body>
</html>